# E-commerce 상품 주문 서비스 요구사항 분석

## 개요
사용자의 잔액으로 결제 및 쿠폰을 받아 할인을 받는 서비스를 만든다
최근 가장 많이 팔린 상위 5개 상품을 선정하여 유저에게 보여줘야 하며, 상품별 재고를 정확하게 파악 할 수 있어야 한다
추가적으로 데이터 분석을 위한 데이터 플랫폼(외부 플랫폼)에 주문 정보를 전송해야 한다

마지막으로, 동시성 제어를 통하여 쿠폰 및 유저 잔액, 재고 등등에 데이터 이상이 생기지 않도록 관리 해야한다.

## API 기능
1. 잔액 충전 API
   - 사용자의 요청에 따라 잔액을 충전 해야 한다
   - 결제와 동시에 충전이 이뤄지는 경우, 잔액에 이상이 생겨서는 안된다
   - 충전 요청 금액이 음수인 경우 예외가 발생해야 한다
   - 충전이 완료되면, 유저 도메인을 응답한다
2. 잔액 조회 API
    - 유저의 잔액을 조회할 수 있어야 한다
3. 상품 조회 API
   - 상품 정보를 조회해야 한다 - 이름, 가격, 잔여 수량을 한번에 조회 할 수 있어야 함
4. 상품 목록 조회 API
   - 상품 목록을 조회 할 수 있어야 한다.
5. 선착순 쿠폰 발급 API
   - 쿠폰재고만큼 요청한 유저들에게 발급한다
   - 쿠폰재고가 다 떨어진 유저들에게는 쿠폰 수량 없음 예외를 발생시켜 응답한다
6. 보유 쿠폰 목록 조회 API
   - 유저 ID 를 받아서, 해당 유저가 보유한 쿠폰을 조회 할 수 있어야 한다
   - 보유한 쿠폰을 응답한다
   - 사용하거나, 기간이 지난 쿠폰은 조회되지 않는다.
7. 주문 API
   - 유저 ID와 상품 ID, 상품 수량을 요청받는다.
   - 상품 ID 의 재고가 충분한지 검증한다
   - 재고가 존재한다면, 해당 유저 ID 에게 상품 수량만큼 임시 부여한다
     - 결제가 중단되면, 재고수량을 해제한다
   - 재고가 부족하다면 재고 부족에 대한 예외를 응답한다
8. 주문 취소 API
   - 상품 재고를 해제한다
   - 쿠폰을 사용했으면 쿠폰 사용도 취소하고 복구한다
9. 결제 API
   - 충전된 잔액을 기반으로 결제 금액이 충분한지 검증한다
   - 쿠폰 요청이 있다면, 쿠폰이 유효한지, 유저가 가지고 있는 쿠폰 ID 인지 검증한다
   - 최종 결제 금액이 상품 금액과 동일한지, 혹은 쿠폰을 사용했다면, 차감된 금액이 동일한지 검증한다
     - 동일하지 않다면, 잘못된 요청 예외를 반환한다
   - 결제가 완료되면, 유저 잔액에서 차감한다
   - 결제 히스토리 내역에 결제 내용을 저장한다
   - 데이터 플랫폼 API 를 호출하여 데이터를 전송한다 (본 프로젝트에서는 Mock API 를 정의한다)
10. 상위 상품 조회 API
   - 결제 히스토리 내역을 참고하여, 가장 많이 팔린 상위 5개 상품을 제공한다
   - 최근 기준은 3일로 잡는다
   - JPA 로 어떻게 통계를 구성할지 고민..


## 비기능적 요구사항
1. 동시성 제어
   - 동시에 여러 주문이 들어올 경우, 유저 보유 잔고가 정확해야 한다
   - 재고 관리에 문제가 없어야 한다
2. 데이터 정합성
   - 잔액과 재고가 트랜잭셔널 하게 처리되어 야 한다
   - 문제가 생기면 롤백이 보장되어야 한다
3. 확장성
   - 인스턴스가 늘어나는 수평 확장이 있어도, 모든 코드가 정상적으로 동작해야한다
4. 성능
   - 상위 상품 조회 API 의 경우, 통계적 계산이 빠르게 동작 할 수 있도록 보장해야한다
5. 데이터 플랫폼 API 연동
   - 재시도 로직 및 비동기 처리
   - 예외 복구 전략
