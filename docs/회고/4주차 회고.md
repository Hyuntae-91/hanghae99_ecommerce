# 4주차 회고


## 배운 점
### 연관관계에 대해서
- 현업에서 ORM 을 사용하지 않고, Raw Query 위주로 개발을 진행하다보니, ORM 과 연관관계가 굉장히 어려웠음
- 연관관계 때문에 오히려 코드가 복잡해지고, 꼬이는 사태가 많이 발생함
- 역시 ORM 을 쓰는건.. 개인적으로 최대한 지양하고 싶음
- 연관관계를 다 걷어내고, 관련 코드를 다 리팩토링 하는데 시간이 꽤 걸려버림

### 통합 테스트
- 나는 통합테스트를 interface(api) layer - DB layer 까지 한번에 테스트하도록 작성
- 하지만, Domain layer 나, application layer 에서도 통합테스트를 수행할 수 있다

| 구분 | Interface Layer 통합테스트 | Domain(application) Layer 통합테스트|
|----|------|------|
|테스트 범위 | Controller -> Service -> Repository -> DB (전체흐름)| Service -> Repository -> DB (비즈니스 로직 중심)|
|입력 방식| 실제 HTTP 요청 처럼 | 메서드 호출|
|검증 대상 | HTTP 상태 코드, 응답 Body, 입력 유효성, Header 등등 | 비즈니스 로직 결과값, DB 상태 변화 등|
|속도 | 상대적으로 느림 | 상대적으로 빠름 |
|작성 난이도 | 복잡 (JSON, header, status 등 고려) | 간결|
|용도 | 실제 클라이언트 요청 흐름을 검증 | 로직이 DB 와 잘 작동하는지 확인하고 싶을 때|

- 주요 비즈니스로직 결과는 Domain Layer 통합테스트에서 처리하고, Interface Layer 에서는 응답 Body 가 정상 동작하는지 위주로 테스트하는게 옳은 방향성일 것 같다
- Testcontainers 를 활용하여 DB 가 자동으로 동작하도록 처리하였다
  - 실무에서도 DB 를 띄워놓고 테스트를 해왔었지만, 자동으로 띄우고 종료하는 테스트는 한적이 없음
  - 테스트에 필요한 container 를 docker-compose 로 구성하고 내가 명령어로 띄운뒤, 테스트를 진행해왔엄
  - 이를 실무에 적용하면 좋을것 같다
  - 다만, mock data 를 insert 하고 테스트를 해야하는 부분에 있어서는 조금 부하가 있을듯?


### 조회 병목 예상 지점 및 인덱스 설정
- 필요한 인덱스를 분석하여 정리하였으며, 성능 비교도 잘 하였다.
- 문서 작성 능력이 떨어져서 보기에는 좀 안좋았다는 점이 마이너스 요소
- 이번 주차 학습을 통해 Pagination 의 단점 및 사용해서는 안되는 이유를 명확하게 파악하였다
  - Cursor 조회 방식으로 선회하는게 좋다!
- [시스템 병목 및 조회 성능 보고서.md](../시스템%20병목%20및%20조회%20성능%20보고서.md)
- 정규화나 [materialized view pattern](https://www.youtube.com/watch?t=1294&v=8OFTB57G9IU&feature=youtu.be) 에 관한 조사를 했었으면 더 좋았을듯..

### 동시성 테스트
- 발생할만한 동시성 이슈를 파악하고 동시성 테스트를 작성함
- 시간 부족으로 모든 동시성 테스트를 작성하진 못함 (-> 5주차 과제에 추가로 넣을 예정)
- CountDownLatch 를 활용하여 작성하였다


### 대용량 DB 데이터 Insert 작업
- 100만건의 데이터를 insert 하는데 가장 빠른 방법은 csv 파일을 만들고 DB 에 직접 접속하여 Load data 명령어 수행
  - 10초 안에 100만건의 데이터 insert 가 가능
- insert bulk 나 단건 insert 로 하면 10분 이상 걸릴 수 있음.
- Procedure 를 이용하여 대용량 데이터를 생성할 수도 있음 (하지만 여전히 느림) -> 새로운 기능 학습이라고 생각하자

### 코드 중복
```text
[OrderService.java](https://github.com/Hyuntae-91/hanghae99_ecommerce/pull/36/commits/8c420ff59d8424c5154c87be7557c2b23c0f81c8#diff-ceb887c47d7637d4bd06fd128bb5e5175a0da83f076870759658ca5618ef7130)파일의 getCart() 메소드와 addCartService() 메소드에 중복되는 코드가 있습니다. (약 9줄)
해당 코드를 공통으로 사용하도록 빼서 추출하려고 했는데, 정확하게 어디에 둬야할지 잘 모르겠습니다.
Service 의 Private 코드로 두자니, 테스트가 불가능한데, 서비스로직을 가지고 있어 불안하고, 그렇다고 Mapper 쪽으로 빼는것도 서비스로직을 단순 mapper 에 빼는게 불합리해 보였습니다.
OrderItem 과 OrderOptions 의 관계이니, OrderItem 도메인 객체에 넣어서 처리하도록 하는게 가장 합리적으로 보이는데, 맞는 방향성인지 몰라서 일단은 유지시켜뒀습니다.
이 부분 관련해서 견해 부탁드리겠습니다.
```

- 코치님의 피드백
```text
여러 방법들이 있는데 간편하게 사용하는 영역으로 private method를 만들어서 헬퍼로써 사용하는 부분입니다.
(
같은 서비스에 위치 하고 다른 서비스에서 사용할 가능성이 없고, 해당 서비스영역이 확장되더라도 헬퍼함수와, 
참조해서 사용하는 메쏘드의 위치를 동일영역으로 두고 이후 분리될 시 다른 방안 고려 
- 이벤트 참조 분리, 모듈 공통 컴포넌트 분리 등
)
```


## 학습이 필요한 부분
- 테스트가 잘 작성되었는가?
- Transactional 에 대해 공부 필요
